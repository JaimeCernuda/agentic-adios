FROM ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    python3 \
    python3-pip \
    nodejs \
    npm \
    build-essential \
    ca-certificates \
    sudo \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Create a user with sudo privileges
RUN useradd -m -s /bin/bash claude-user && \
    echo "claude-user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    usermod -aG sudo claude-user

# Install bc for calculations
RUN apt-get update && apt-get install -y bc && rm -rf /var/lib/apt/lists/*

# Install Claude Code (real version)
RUN curl -fsSL https://claude.ai/claude-code/install.sh | sh

# Create workspace directory and set proper permissions
RUN mkdir -p /workspace && chmod 755 /workspace

# Copy necessary scripts
COPY telemetry-wrapper.sh shutdown-export.sh export-telemetry.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/telemetry-wrapper.sh /usr/local/bin/shutdown-export.sh \
    /usr/local/bin/export-telemetry.sh

# Create necessary directories
RUN mkdir -p /telemetry /logs /exported-data && \
    chown -R claude-user:claude-user /workspace /telemetry /logs /exported-data

# Configure MCP for Adios  
RUN mkdir -p /home/claude-user/.claude && \
    echo '{"mcpServers": {"adios": {"command": "npx", "args": ["-y", "@adios-ai/server"], "env": {}}}}' > /home/claude-user/.claude/settings.json && \
    chown -R claude-user:claude-user /home/claude-user

# Mock Adios MCP server setup (for testing)
RUN mkdir -p /home/claude-user/.npm && \
    echo "Adios MCP server would be installed here" > /home/claude-user/.npm/adios-info.txt && \
    chown -R claude-user:claude-user /home/claude-user/.npm

# No test scripts needed

USER claude-user

# Set up environment for telemetry
ENV CLAUDE_CODE_ENABLE_TELEMETRY=1
ENV OTEL_SERVICE_NAME=claude-code
ENV OTEL_RESOURCE_ATTRIBUTES="service.name=claude-code,deployment.environment=company-exploration"
ENV PATH="/home/claude-user/.local/bin:${PATH}"

# Set telemetry environment variables
ENV TELEMETRY_DIR=/telemetry
ENV LOGS_DIR=/logs
ENV EXPORTED_DATA_DIR=/exported-data

# Set working directory to /home/claude-user to avoid mount namespace issues
WORKDIR /home/claude-user

# Direct entrypoint to claude with dangerous mode
ENTRYPOINT ["/usr/local/bin/telemetry-wrapper.sh", "claude", "--dangerously-skip-permissions"]