FROM ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    python3 \
    python3-pip \
    nodejs \
    npm \
    build-essential \
    ca-certificates \
    sudo \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user for Claude Code
RUN useradd -m -s /bin/bash claudecode && \
    echo "claudecode ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install bc for calculations
RUN apt-get update && apt-get install -y bc && rm -rf /var/lib/apt/lists/*

# Copy mock Claude Code for testing
COPY mock-claude.sh /usr/local/bin/claude
RUN chmod +x /usr/local/bin/claude

# Create app directory
WORKDIR /app

# Copy telemetry collection scripts
COPY entrypoint.sh /app/entrypoint.sh
COPY session-wrapper.sh /usr/local/bin/session-wrapper
COPY telemetry-wrapper.sh /usr/local/bin/telemetry-wrapper
COPY shutdown-export.sh /app/shutdown-export.sh
RUN chmod +x /app/entrypoint.sh /usr/local/bin/session-wrapper /usr/local/bin/telemetry-wrapper /app/shutdown-export.sh

# Create necessary directories
RUN mkdir -p /workspace /telemetry /logs && \
    chown -R claudecode:claudecode /workspace /telemetry /logs

# Configure MCP for Adios
RUN mkdir -p /home/claudecode/.claudecode && \
    echo '{"mcpServers": {"adios": {"command": "npx", "args": ["-y", "@adios-ai/server"], "env": {}}}}' > /home/claudecode/.claudecode/settings.json && \
    chown -R claudecode:claudecode /home/claudecode

# Mock Adios MCP server setup (for testing)
RUN mkdir -p /home/claudecode/.npm && \
    echo "Adios MCP server would be installed here" > /home/claudecode/.npm/adios-info.txt && \
    chown -R claudecode:claudecode /home/claudecode/.npm

USER claudecode

# Set up environment for telemetry
ENV CLAUDE_CODE_ENABLE_TELEMETRY=1
ENV OTEL_SERVICE_NAME=claude-code
ENV OTEL_RESOURCE_ATTRIBUTES="service.name=claude-code,deployment.environment=company-exploration"
ENV PATH="/home/claudecode/.local/bin:${PATH}"

WORKDIR /workspace

ENTRYPOINT ["/app/entrypoint.sh"]